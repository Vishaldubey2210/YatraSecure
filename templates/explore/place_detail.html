{% extends 'base.html' %}
{% load static %}

{% block title %}{{ place.name }} - Explore India{% endblock %}

{% block extra_css %}
<style>
.place-header {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    color: #000;
}

.photo-grid-masonry {
    column-count: 3;
    column-gap: 1rem;
}

.photo-item {
    break-inside: avoid;
    margin-bottom: 1rem;
    position: relative;
    border-radius: 15px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    cursor: pointer;
    transition: all 0.3s ease;
}

.photo-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.photo-item img {
    width: 100%;
    display: block;
}

.photo-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
    padding: 1rem;
    color: white;
}

.like-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.like-btn:hover {
    transform: scale(1.2);
}

.like-btn.liked {
    color: #ff4757;
}

.photo-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    overflow-y: auto;
}

.photo-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content-photo {
    max-width: 900px;
    width: 90%;
    background: rgba(20, 20, 40, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    overflow: hidden;
}

.modal-image {
    width: 100%;
    max-height: 70vh;
    object-fit: contain;
}

.comments-section {
    max-height: 300px;
    overflow-y: auto;
    padding: 1rem;
}

.comment-item {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

@media (max-width: 768px) {
    .photo-grid-masonry {
        column-count: 2;
    }
}

@media (max-width: 480px) {
    .photo-grid-masonry {
        column-count: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Place Header -->
    <div class="place-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">{{ place.name }}</h1>
                <p class="mb-2">
                    <i class="fas fa-map-marker-alt"></i> {{ place.city }}, {{ place.state }}
                </p>
                <p class="mb-3">{{ place.description }}</p>
                <div class="d-flex gap-3 flex-wrap">
                    <span class="badge bg-dark">
                        <i class="fas fa-star"></i> {{ place.rating }} Rating
                    </span>
                    <span class="badge bg-dark">
                        <i class="fas fa-camera"></i> {{ photos.count }} Photos
                    </span>
                    <span class="badge bg-dark">
                        <i class="fas fa-eye"></i> {{ place.view_count }} Views
                    </span>
                    <span class="badge bg-dark">
                        <i class="fas fa-tag"></i> {{ place.get_category_display }}
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a href="{% url 'explore:upload_photo' place.id %}" class="btn btn-dark btn-lg">
                    <i class="fas fa-camera"></i> Upload Photo
                </a>
                <a href="{% url 'explore:explore_home' %}" class="btn btn-outline-dark btn-lg">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>
    </div>

    <!-- Photos Grid -->
    {% if photos %}
    <div class="photo-grid-masonry">
        {% for photo in photos %}
        <div class="photo-item" data-photo-id="{{ photo.id }}">
            <img src="{{ photo.image.url }}" alt="{{ place.name }}">
            <div class="photo-actions">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="like-btn {% if photo.id in liked_photo_ids %}liked{% endif %}" 
                                data-photo-id="{{ photo.id }}">
                            <i class="fas fa-heart"></i> <span class="likes-count">{{ photo.likes_count }}</span>
                        </button>
                        <button class="comment-btn ms-3" data-photo-id="{{ photo.id }}">
                            <i class="fas fa-comment"></i> {{ photo.comments.count }}
                        </button>
                    </div>
                    <small>@{{ photo.user.username }}</small>
                </div>
                {% if photo.caption %}
                <p class="mb-0 mt-2 small">{{ photo.caption }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-camera fa-4x mb-3 opacity-50"></i>
        <h4>No photos yet</h4>
        <p class="opacity-75 mb-4">Be the first to share a photo of {{ place.name }}!</p>
        <a href="{% url 'explore:upload_photo' place.id %}" class="btn btn-gradient-primary btn-lg">
            <i class="fas fa-camera"></i> Upload First Photo
        </a>
    </div>
    {% endif %}
</div>

<!-- Photo Modal -->
<div class="photo-modal" id="photoModal">
    <div class="modal-content-photo">
        <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <button class="btn btn-sm btn-outline-light float-end" onclick="closePhotoModal()">
                <i class="fas fa-times"></i>
            </button>
            <h5 id="modalPhotoUser"></h5>
        </div>
        <img id="modalImage" class="modal-image" src="" alt="">
        <div style="padding: 1rem;">
            <div class="d-flex gap-3 mb-3">
                <button class="btn btn-outline-light like-btn-modal" id="modalLikeBtn">
                    <i class="fas fa-heart"></i> <span id="modalLikesCount">0</span>
                </button>
                <span class="text-muted"><i class="fas fa-comment"></i> <span id="modalCommentsCount">0</span> comments</span>
            </div>
            <p id="modalCaption" class="mb-3"></p>
            
            <!-- Comments -->
            <div class="comments-section" id="commentsSection"></div>
            
            <!-- Add Comment -->
            {% if user.is_authenticated %}
            <form id="commentForm" class="mt-3">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" id="commentInput" class="form-control glass-input" 
                           placeholder="Add a comment..." required>
                    <button type="submit" class="btn btn-primary">Post</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
let currentPhotoId = null;

// Like functionality
document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const photoId = this.dataset.photoId;
        
        fetch(`/explore/photo/${photoId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.liked) {
                this.classList.add('liked');
            } else {
                this.classList.remove('liked');
            }
            this.querySelector('.likes-count').textContent = data.likes_count;
        });
    });
});

// Open photo modal
document.querySelectorAll('.photo-item').forEach(item => {
    item.addEventListener('click', function() {
        const photoId = this.dataset.photoId;
        currentPhotoId = photoId;
        // Load photo details and show modal
        document.getElementById('photoModal').classList.add('active');
    });
});

function closePhotoModal() {
    document.getElementById('photoModal').classList.remove('active');
}

// Comment form
document.getElementById('commentForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('commentInput');
    const text = input.value.trim();
    
    if (!text) return;
    
    fetch(`/explore/photo/${currentPhotoId}/comment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `text=${encodeURIComponent(text)}`
    })
    .then(r => r.json())
    .then(data => {
        input.value = '';
        // Add comment to UI
        const commentHtml = `
            <div class="comment-item">
                <strong>@${data.comment.user}</strong>
                <p class="mb-1">${data.comment.text}</p>
                <small class="text-muted">${data.comment.created_at}</small>
            </div>
        `;
        document.getElementById('commentsSection').insertAdjacentHTML('beforeend', commentHtml);
    });
});
</script>
{% endblock %}
