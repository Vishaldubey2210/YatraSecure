{% extends 'base.html' %}
{% load static %}

{% block title %}SOS Emergency - YatraSecure{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center align-items-center" style="min-height: 70vh;">
        <div class="col-md-6">
            <div class="glass-card text-center sos-card">
                <div class="sos-icon mb-4">
                    <i class="fas fa-exclamation-triangle fa-5x text-danger"></i>
                </div>
                <h2 class="fw-bold mb-3">Emergency SOS</h2>
                <p class="lead mb-4 opacity-75">
                    Press the button below to send emergency alert to your contacts
                </p>

                <button id="sosButton" class="btn btn-gradient-danger btn-lg px-5 py-3 mb-4" onclick="sendSOS()">
                    <i class="fas fa-exclamation-circle fa-2x"></i><br>
                    <span class="h4">SEND SOS ALERT</span>
                </button>

                <div class="alert alert-warning glass-card" role="alert">
                    <i class="fas fa-info-circle"></i> 
                    This will send your live location to your emergency contacts via WhatsApp
                </div>

                <div id="sosStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<style>
.sos-card {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
    }
    50% {
        box-shadow: 0 0 40px rgba(255, 0, 0, 0.6);
    }
}

.sos-icon {
    animation: shake 0.5s infinite;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.btn-gradient-danger {
    background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%);
    animation: buttonPulse 1.5s infinite;
}

@keyframes buttonPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>

<script>
function sendSOS() {
    const button = document.getElementById('sosButton');
    const status = document.getElementById('sosStatus');
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Alert...';
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            fetch("{% url 'safety:sos_alert' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `latitude=${lat}&longitude=${lng}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    status.innerHTML = `
                        <div class="alert alert-success glass-card">
                            <i class="fas fa-check-circle"></i> SOS Alert Sent!<br>
                            <a href="${data.whatsapp_url}" target="_blank" class="btn btn-success mt-2">
                                <i class="fab fa-whatsapp"></i> Open WhatsApp
                            </a>
                        </div>
                    `;
                    window.open(data.whatsapp_url, '_blank');
                } else {
                    status.innerHTML = `
                        <div class="alert alert-danger glass-card">
                            <i class="fas fa-exclamation-circle"></i> ${data.message}
                        </div>
                    `;
                }
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-exclamation-circle"></i> SEND SOS ALERT';
            });
        }, function(error) {
            status.innerHTML = `
                <div class="alert alert-danger glass-card">
                    <i class="fas fa-exclamation-circle"></i> Location access denied. Please enable location services.
                </div>
            `;
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-exclamation-circle"></i> SEND SOS ALERT';
        });
    } else {
        status.innerHTML = `
            <div class="alert alert-danger glass-card">
                <i class="fas fa-exclamation-circle"></i> Geolocation not supported by browser
            </div>
        `;
        button.disabled = false;
    }
}
</script>
{% endblock %}
